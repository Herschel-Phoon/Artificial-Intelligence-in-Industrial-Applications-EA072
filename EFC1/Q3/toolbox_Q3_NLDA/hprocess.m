% FEEC/Unicamp
% 25/05/2017
% function [s] = hprocess(X,S,w1,w2,w3,w4,p1,p2,p3,p4,n,m,N)
% s = product H*p (computed exactly)
%
function [s] = hprocess(X,S,w1,w2,w3,w4,p1,p2,p3,p4,n,m,N)
x1 = [X ones(N,1)];
rx1 = zeros(N,m+1);
y1 = tanh(x1*w1');
ry1 = (x1*p1'+rx1*w1').*(1.0-y1.*y1);
x2 = [y1 ones(N,1)];
rx2 = [ry1 zeros(N,1)];
% y2 = tanh(x2*w2');
y2 = x2*w2';
% ry2 = (x2*p2'+rx2*w2').*(1.0-y2.*y2);
ry2 = x2*p2'+rx2*w2';
x3 = [y2 ones(N,1)];
rx3 = [ry2 zeros(N,1)];
y3 = tanh(x3*w3');
ry3 = (x3*p3'+rx3*w3').*(1.0-y3.*y3);
x4 = [y3 ones(N,1)];
rx4 = [ry3 zeros(N,1)];
% y4 = tanh(x4*w4');
y4 = x4*w4';
% ry4 = (x4*p4'+rx4*w4').*(1.0-y4.*y4);
ry4 = x4*p4'+rx4*w4';
erro = y4-S;
% erro4 = erro.*(1.0-y4.*y4);
erro4 = erro;
% rerro4 = ry4.*(1.0-y4.*y4) + erro.*(-2*y4.*ry4);
rerro4 = ry4;
rw4 = erro4'*rx4+rerro4'*x4;
erro3 = (erro4*w4(:,1:n(3))).*(1.0-y3.*y3);
rerro3 = (rerro4*w4(:,1:n(3))+erro4*p4(:,1:n(3))).*(1.0-y3.*y3)+(erro4*w4(:,1:n(3))).*(-2*y3.*ry3);
rw3 = erro3'*rx3+rerro3'*x3;
% erro2 = (erro3*w3(:,1:n(2))).*(1.0-y2.*y2);
erro2 = erro3*w3(:,1:n(2));
% rerro2 = (rerro3*w3(:,1:n(2))+erro3*p3(:,1:n(2))).*(1.0-y2.*y2)+(erro3*w3(:,1:n(2))).*(-2*y2.*ry2);
rerro2 = rerro3*w3(:,1:n(2))+erro3*p3(:,1:n(2));
rw2 = erro2'*rx2+rerro2'*x2;
erro1 = (erro2*w2(:,1:n(1))).*(1.0-y1.*y1);
rerro1 = (rerro2*w2(:,1:n(1))+erro2*p2(:,1:n(1))).*(1.0-y1.*y1)+(erro2*w2(:,1:n(1))).*(-2*y1.*ry1);
rw1 = erro1'*rx1+rerro1'*x1;
rEw = [reshape(rw1',n(1)*(m+1),1);reshape(rw2',n(2)*(n(1)+1),1);reshape(rw3',n(3)*(n(2)+1),1);reshape(rw4',n(4)*(n(3)+1),1)];
s = rEw;
